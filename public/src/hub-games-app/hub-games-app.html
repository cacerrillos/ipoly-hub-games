<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="games-page.html">
<link rel="import" href="team-page.html">
<link rel="import" href="leaderboard-page.html">
<link rel="import" href="schedule-page.html">
<link rel="import" href="hub-styles.html">



<dom-module id="hub-games-app">
  <template>
    <style include="iron-flex iron-flex-alignment hub-styles">
      :host {
        display: block;
      }
    </style>

    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{tail}}"></app-route>

    <iron-ajax
      auto
      id="participantsAjax"
      url="[[_computeAPI('/participants')]]"
      handle-as="json"
      on-response="handleResponse"
      last-response="{{participants}}"></iron-ajax>
    <iron-ajax
      auto
      id="gamesAjax"
      url="[[_computeAPI('/games')]]"
      handle-as="json"
      on-response="handleResponse"
      last-response="{{games}}"></iron-ajax>
    <iron-ajax
      auto
      id="scheduleAjax"
      url="[[_computeAPI('/schedule')]]"
      handle-as="json"
      on-response="handleResponse"
      last-response="{{schedule}}"></iron-ajax>
    <iron-ajax
      auto
      id="scoresAjax"
      url="[[_computeAPI('/scores')]]"
      handle-as="json"
      last-response="{{scores}}"></iron-ajax>


      <!--<paper-header-panel>-->
        <paper-toolbar>
          <div style="width: 100%;" class="layout horizontal">
            <div class="vcenter">iPoly Hub Games</div>
            <div class="flex"></div>
            
            <paper-button on-tap="_handleGotoPage" data-page="leaderboard">Leaderboard</paper-button>
            <paper-button on-tap="_handleGotoPage" data-page="schedule">Schedule</paper-button>
            <!-- <paper-button on-tap="_handleGotoPage" data-page="teams">Teams</paper-button> -->
            <paper-button on-tap="_handleGotoPage" data-page="games">Games</paper-button>
          </div>
          
        </paper-toolbar>
        <div class="container">
          <div class="content">
            <iron-pages selected="[[routeData.page]]" attr-for-selected="name">
              <leaderboard-page
                name="leaderboard"
                games="[[games]]"
                scores="[[scores]]"
                participants="[[participants]]"
                route="{{route}}"
                ></leaderboard-page>
              <schedule-page
                name="schedule"
                participants="[[participants]]"
                games="[[games]]"
                schedule="[[schedule]]"
                route="{{route}}"
                ></schedule-page>
              <games-page
                name="games"
                games="[[games]]"
                games-array="[[gamesArray]]"
                scores="[[scores]]"
                participants="[[participants]]"
                participants-array="[[participantsArray]]"
                route="{{route}}"
                ></games-page>
              <team-page
                name="teams"
                participants="[[participants]]"
                participants-array="[[participantsArray]]"
                scores="[[scores]]"
                games="[[games]]"
                schedule="[[schedule]]"
                route="{{route}}"
                ></team-page>
            </iron-pages>
            
            
            
            
          </div>
        </div>
        <!-- wegb
        <paper-material elevation="1">
          saasdasd
        </paper-material> -->
      <!--</paper-header-panel>-->
    <paper-toast id="globalToast"></paper-toast>
  </template>
  <script>
    Polymer({

      is: 'hub-games-app',

      properties: {
        page: {
          type: String,
          observer: '_onPageChanged'
        },
        routeData: {
          type: Object
        },
        tail: {
          type: Object
        },
        games: {
          type: Object
        },
        gamesArray: {
          type: Array,
          computed: '_objToArr(games)'
        },
        participants: {
          type: Object
        },
        participantsArray: {
          type: Array,
          computed: '_objToArr(participants)'
        },
        schedule: {
          type: Object
        },
        scores: {
          type: Object
        }
      },
      observers: [
      ],
      listeners: {
        'goto-page': '_handleGotoPage',
        'firetoast': '_handleToast',
        'show-back-button': '_handleShowBackButton',
        'reload-data': '_reloadData'
      },
      _reloadData: function(e) {
        this.$.participantsAjax.generateRequest();
        this.$.gamesAjax.generateRequest();
        this.$.scoresAjax.generateRequest();
        this.$.scheduleAjax.generateRequest();
      },
      _computeAPI: function (path) {
        // switch(path) {
        //   default:
        //     break;
        //   case '/games':
        //     return this.resolveUrl('../../games.json');
        //   case '/schedule':
        //     return this.resolveUrl('../../schedule.json');
        //   case '/participants':
        //     return this.resolveUrl('../../participants.json');
        // }
        var apiRootPath = 'https://zerx6mo164.execute-api.us-east-2.amazonaws.com/v1';
        return apiRootPath + path;
      },
      _log: function(e) {
        console.log(e);
      },
      _objToArr: function(obj) {
        if(obj)
          return Object.keys(obj).map(function (key) { return obj[key]; });
        return [];
      },
      _getAttrFromObj: function(key, attr, obj) {
        if(obj && key && obj[key] && obj[key][attr]) {
          return obj[key][attr];
        }
        return "error";
      },
      ready: function(e) {
        if(this.routeData) {
          if(this.routeData.page == undefined || this.routeData.page == '') {
            window.location.href = '#/leaderboard';
          }
        }
      },
      _handleSetTitle: function(e) {
        if(e && e.detail && e.detail.title) {
          this.titleText = e.detail.title;          
        } else {
          this.titleText = '';
        }
      },
      _handleGotoPage: function(e) {
        var page = undefined;
        if(e) {
          if(typeof e === 'string' || e instanceof String) {
            page = e;

          } else if(e instanceof Event) {
            if(e.type == 'tap') {
              if(e.target.getAttribute('data-page')) {
                page = e.target.getAttribute('data-page');
              }
            } else if(e.detail && e.detail.page) {
              page = e.detail.page;
            }
          }
        }
        if(page)
          this.set('route.path', '/' + page);
      },
      _onPageChanged: function(e) {
        console.log('changed: ' + e);
        this.set('route.path', '/' + e);
      },
      _handleToast: function(e) {
        if(e && e.detail) {
          this.$.globalToast.text = e.detail.message;
          this.$.globalToast.show();
        }
      },
      _handleShowBackButton: function(e) {
        var temp = true;
        if(e.detail !== undefined)
          temp = e.detail;

        this.$.backButton.hidden = !temp;
        this.$.menuButton.hidden = temp;
      },
      _goBack: function(e) {
        this.$.backButton.hidden = true;
        this.$.menuButton.hidden = false;
        window.history.back();
      }
    });
  </script>
</dom-module>